
(function () {
    'use strict';

    const STORAGE_KEY = 'tw_script_manager_state_v2';
    const savedState = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');

    const categories = {
        ataque: '‚öîÔ∏è Ataque',
        defesa: 'üõ°Ô∏è Defesa',
        organizacao: 'üß© Organiza√ß√£o'
    };

    const scripts = [
        {
            name: 'Conversor Defesa POP',
            key: 'conversor',
            icon: 'üõ†Ô∏è',
            tooltip: 'Converter tropas em c√≥digo de defesa BB',
            url: 'https://raw.githubusercontent.com/eleicaotw/TWSetupPro/refs/heads/main/conversor-forum-code-bb-defesa.js',
            categoria: 'organizacao'
        },
        {
            name: 'MP OP Auto',
            key: 'mpop',
            icon: 'üì®',
            tooltip: 'Automatizar envio de MPs em OPs',
            url: 'https://raw.githubusercontent.com/eleicaotw/TWSetupPro/refs/heads/main/mp-op-auto.js',
            categoria: 'organizacao'
        }
    ];

    const style = document.createElement('style');
    style.textContent = `
        #tw_script_manager_painel {
            position: fixed;
            top: 120px;
            left: 20px;
            z-index: 9999;
            background: #f4e4bc;
            padding: 15px;
            border: 2px solid #c4a300;
            font-family: Verdana;
            border-radius: 12px;
            box-shadow: 2px 2px 8px #0006;
            transition: opacity 0.3s ease;
        }
        #tw_script_manager_painel.dark {
            background: #2b2b2b;
            color: #f0f0f0;
            border: 2px solid #888;
        }
        #tw_script_log {
            margin-top: 10px;
            font-size: 11px;
        }
        .tw_script_loaded {
            color: green;
            font-weight: bold;
        }
        .tw_script_category {
            font-weight: bold;
            padding-top: 8px;
            background-color: #f1f1f1;
            padding: 5px;
            border-radius: 6px;
            margin-bottom: 5px;
        }
        .tw_script_action {
            margin-left: 5px;
            cursor: pointer;
        }
        .tw_script_toggle {
            cursor: pointer;
            padding: 5px;
            background-color: #007bff;
            color: #fff;
            border-radius: 4px;
            margin-top: 5px;
            display: inline-block;
        }
        .tw_script_toggle_off {
            background-color: #dc3545;
        }
        #tw_script_manager_painel.dragging {
            opacity: 0.7;
        }
    `;
    document.head.appendChild(style);

    const painel = document.createElement('div');
    painel.id = 'tw_script_manager_painel';
    painel.style.display = 'none';
    painel.innerHTML = `
        <b>Menu de Scripts</b><br>
        <button id="update_scripts_button" style="margin:10px;width:100%; padding:8px;background-color:#28a745;color:#fff;border-radius:5px;">Atualizar Scripts</button>
        <div id="lista_scripts" style="margin-top:5px;"></div>
        <div id="tw_script_log" style="color: green;"></div>
    `;
    document.body.appendChild(painel);

    // Engrenagem (bot√£o flutuante)
    const toggleBtn = document.createElement('div');
    toggleBtn.className = 'quest';
    toggleBtn.id = 'tw_toggle_interface';
    toggleBtn.title = 'Abrir Script Manager';
    toggleBtn.style.backgroundImage = 'url(https://dsbr.innogamescdn.com/asset/47657033/graphic/icons/settings.png)';
    toggleBtn.style.cursor = 'pointer';
    document.getElementById('questlog_new')?.appendChild(toggleBtn);

    toggleBtn.onclick = () => {
        painel.style.display = painel.style.display === 'none' ? 'block' : 'none';
    };

    // Mini log
    const log = document.getElementById('tw_script_log');
    const addLog = (msg, color = 'green') => {
        const time = new Date().toLocaleTimeString();
        log.innerHTML = `<span style="color:${color}">[${time}] ${msg}</span>`;
    };

    // Fun√ß√£o para carregar scripts com categorias
    const container = document.getElementById('lista_scripts');

    const render = () => {
        container.innerHTML = '';
        const ocultar = false;  // N√£o ocultar desativados para o teste de layout

        Object.keys(categories).forEach(cat => {
            const group = scripts.filter(s => s.categoria === cat);
            if (group.length === 0) return;

            const catDiv = document.createElement('div');
            catDiv.className = 'tw_script_category';
            catDiv.textContent = categories[cat];
            container.appendChild(catDiv);

            group.forEach(script => {
                const ativo = savedState[script.key];
                const div = document.createElement('div');
                div.title = script.tooltip;
                div.innerHTML = `
                    ${script.icon} ${script.name}
                    ${ativo ? '<span class="tw_script_loaded">‚úîÔ∏è</span>' : ''}
                    <span class="tw_script_toggle ${ativo ? '' : 'tw_script_toggle_off'}" data-key="${script.key}">
                        ${ativo ? 'Desativar' : 'Ativar'}
                    </span>
                    <span class="tw_script_action" data-reload="${script.key}" title="Recarregar">üîÑ</span>
                `;
                container.appendChild(div);
            });
        });
    };

    // Fun√ß√£o para atualizar todos os scripts
    const updateScripts = () => {
        addLog('Atualizando scripts...');
        scripts.forEach(script => {
            loadScript(script, true);
        });
    };

    const loadScript = (script, force = false) => {
        if (document.getElementById(`tw_script_${script.key}`) && !force) return;
        fetch(script.url)
            .then(res => res.text())
            .then(code => {
                eval(code);
                addLog(`${script.name} carregado`);
            })
            .catch(err => addLog(`Erro ao carregar ${script.name}: ${err}`, 'red'));
    };

    // Eventos
    painel.addEventListener('click', (e) => {
        const el = e.target;
        if (el.id === 'update_scripts_button') {
            updateScripts();
        }
        if (el.dataset.reload) {
            const key = el.dataset.reload;
            const script = scripts.find(s => s.key === key);
            if (script) {
                loadScript(script, true);
            }
        }

        if (el.classList.contains('tw_script_toggle')) {
            const key = el.dataset.key;
            const script = scripts.find(s => s.key === key);
            if (script) {
                const ativo = savedState[script.key] = !savedState[script.key];
                localStorage.setItem(STORAGE_KEY, JSON.stringify(savedState));
                render();
                if (ativo) {
                    loadScript(script);
                }
            }
        }
    });

    // Reaplicar scripts marcados
    scripts.forEach(s => {
        if (savedState[s.key]) {
            loadScript(s);
        }
    });

    render();
})();
