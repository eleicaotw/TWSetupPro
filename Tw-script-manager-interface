(function () {
    'use strict';

    const STORAGE_KEY = 'tw_script_manager_state';
    const savedState = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');

    const scripts = [
        {
            name: 'Conversor Defesa POP',
            key: 'conversor',
            icon: 'üõ°Ô∏è',
            tooltip: 'Converter tropas em c√≥digo de defesa BB',
            url: 'https://raw.githubusercontent.com/eleicaotw/TWSetupPro/refs/heads/main/conversor-forum-code-bb-defesa.js'
        },
        {
            name: 'MP OP Auto',
            key: 'mpop',
            icon: 'üì®',
            tooltip: 'Automatizar envio de MPs em OPs',
            url: 'https://raw.githubusercontent.com/eleicaotw/TWSetupPro/refs/heads/main/mp-op-auto.js'
        }
    ];

    const painel = document.createElement('div');
    painel.style = 'position: fixed; top: 100px; left: 20px; z-index: 9999; background: #f4e4bc; padding: 10px; border: 2px solid #c4a300; font-family: Verdana; border-radius: 12px; box-shadow: 2px 2px 8px #0006;';
    painel.innerHTML = `<b>Menu de Scripts</b><br>
        <table style="margin-top: 6px;">
            <thead><tr><th style="text-align:left">Script</th><th>Ativar</th></tr></thead>
            <tbody id="lista_scripts"></tbody>
        </table>
        <div id="tw_script_log" style="margin-top: 10px; font-size: 11px; color: green;"></div>`;
    painel.id = 'tw_script_manager_painel';
    painel.style.display = 'none';
    document.body.appendChild(painel);

    // Bot√£o no estilo miss√µes com engrenagem
    const toggleBtn = document.createElement('div');
    toggleBtn.className = 'quest';
    toggleBtn.id = 'tw_toggle_interface';
    toggleBtn.title = 'Abrir Script Manager';
    toggleBtn.style.backgroundImage = 'url(https://dsbr.innogamescdn.com/asset/47657033/graphic/icons/settings2.png)';
    toggleBtn.style.cursor = 'pointer';

    toggleBtn.onclick = () => {
        const isVisible = painel.style.display !== 'none';
        painel.style.display = isVisible ? 'none' : 'block';
    };

    const questlog = document.getElementById('questlog_new');
    if (questlog) questlog.appendChild(toggleBtn);

    const lista = document.getElementById('lista_scripts');
    const log = document.getElementById('tw_script_log');

    const addLog = (msg) => {
        const time = new Date().toLocaleTimeString();
        log.textContent = `[${time}] ${msg}`;
    };

    scripts.forEach(script => {
        const tr = document.createElement('tr');
        const tdName = document.createElement('td');
        tdName.innerHTML = `${script.icon} ${script.name}`;
        tdName.title = script.tooltip;

        const tdToggle = document.createElement('td');
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.checked = !!savedState[script.key];

        checkbox.onchange = () => {
            if (checkbox.checked) {
                fetch(script.url)
                    .then(res => res.text())
                    .then(code => {
                        eval(code);
                        savedState[script.key] = true;
                        localStorage.setItem(STORAGE_KEY, JSON.stringify(savedState));
                        addLog(`${script.name} carregado`);
                    })
                    .catch(err => alert(`Erro ao carregar ${script.name}: ${err}`));
            } else {
                savedState[script.key] = false;
                localStorage.setItem(STORAGE_KEY, JSON.stringify(savedState));
                addLog(`${script.name} desativado (recarregue para remover efeitos)`);
            }
        };

        // Autoexecu√ß√£o se estiver salvo como ativo
        if (checkbox.checked) {
            fetch(script.url)
                .then(res => res.text())
                .then(code => {
                    eval(code);
                    addLog(`${script.name} reativado`);
                });
        }

        tdToggle.appendChild(checkbox);
        tr.appendChild(tdName);
        tr.appendChild(tdToggle);
        lista.appendChild(tr);
    });
})();
