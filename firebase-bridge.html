<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Firebase Bridge</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
</head>
<body>
  <script>
    console.log("[🔥 BRIDGE] Iniciando bridge...");

    const firebaseConfig = {
      apiKey: "AIzaSyDYa-N1F2pHNjyhsEeo8ApypZDk0zz4nU0",
      authDomain: "etiquetador-marquesscript.firebaseapp.com",
      databaseURL: "https://etiquetador-marquesscript-default-rtdb.firebaseio.com",
      projectId: "etiquetador-marquesscript",
      storageBucket: "etiquetador-marquesscript.appspot.com",
      messagingSenderId: "400813493512",
      appId: "1:400813493512:web:e8d3ba4f46fa457bda70bd"
    };

    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
      console.log("[✅ BRIDGE] Firebase inicializado.");
    } else {
      console.warn("[⚠️ BRIDGE] Firebase já estava inicializado.");
    }

    // Aguarda mensagens do script externo
    window.addEventListener("message", async (event) => {
      console.log("[🔥 BRIDGE] Mensagem recebida:", event.data);

      if (!event.data || event.data.type !== "set-status" || !event.data.nick) {
        console.warn("[⚠️ BRIDGE] Dados inválidos recebidos.");
        return;
      }

      const nick = event.data.nick;

      try {
        await firebase.database().ref("players/" + nick).set({
          status: "online",
          lastSeen: new Date().toISOString()
        });
        console.log(`[✅ BRIDGE] Status de ${nick} sincronizado com sucesso.`);
      } catch (e) {
        console.error("[❌ BRIDGE] Erro ao escrever no Firebase:", e);
      }
    });

    // Atualiza para offline ao sair
    window.addEventListener("beforeunload", () => {
      const nick = document.querySelector('#menu_row2 b')?.textContent?.trim() || "Desconhecido";
      firebase.database().ref("players/" + nick).set({
        status: "offline",
        lastSeen: new Date().toISOString()
      });
    });
  </script>
</body>
</html>
